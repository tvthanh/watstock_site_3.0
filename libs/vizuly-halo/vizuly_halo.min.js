/*! vizuly 23-06-2016 */
vizuly.viz.halo_cluster=function(a){function b(){u=h.selection.append("svg").attr("id",h.id).style("overflow","visible").attr("class","vizuly"),C=vizuly.util.getDefs(k),w=u.append("rect").attr("class","vz-background"),v=u.append("g").attr("class","vz-halo-viz"),x=v.append("g").attr("class","vz-halo-plot").attr("clip-path","url(#"+h.id+"_plotClipPath)"),y=x.append("rect").attr("class","vz-plot-background"),B=x.append("g").attr("class","vz-halo-link-plot"),A=x.append("g").attr("class","vz-halo-node-plot"),z=x.append("g").attr("class","vz-halo-arc-plot"),h.dispatch.initialize()}function c(){k.validate(),1==l&&(f(),B.selectAll("path").remove(),B.selectAll("circle").remove(),z.selectAll("path").remove(),A.selectAll("circle").remove(),l=!1),m=vizuly.util.size(h.margin,h.width,h.height),o=Math.min(m.width,m.height)/2,n=o*(1-h.haloThickness),H.size([2*n*.99,2*n*.99]).padding(2).sort(null).value(function(a){return a.value}).children(function(a){return a.children}),F.padAngle(h.padAngle*D).startAngle(0).endAngle(360*D).value(function(a){return a.value}),G.value(h.value).padAngle(0),E.outerRadius(o).innerRadius(n),t=H.nodes({children:s}).filter(function(a){return a.depth>1}),h.dispatch.measure();for(var a in r)r[a].aggregate=0}function d(){c(),u.attr("width",h.width).attr("height",h.height),w.attr("width",h.width).attr("height",h.height),x.style("width",m.width).style("height",m.height).attr("transform","translate("+m.left+","+m.top+")"),z.attr("transform","translate("+m.width/2+","+m.height/2+")"),B.attr("transform","translate("+m.width/2+","+m.height/2+")"),A.attr("transform","translate("+(m.width-2*n)/2+","+(m.height-2*n)/2+")");var a=z.selectAll(".vz-halo-arc").data(F(p));a.enter().append("path").attr("class",function(a){return"vz-halo-arc halo-key_"+a.data.key}).on("mouseover",function(a,b){h.dispatch.arcover(this,a,b)}).on("mouseout",function(a,b){h.dispatch.arcout(this,a,b)}),a.exit().remove(),a.attr("d",function(a,b){return E(a,b)}),a.each(function(a){var b=a.startAngle+(a.endAngle-a.startAngle)/2-90*D;a.x=n*Math.cos(b),a.y=n*Math.sin(b)});var b=B.selectAll(".vz-halo-group").data(F(p));b.enter().append("g").attr("class","vz-halo-group"),b.exit().remove(),b.each(function(a){G.startAngle(a.startAngle+F.padAngle()/1.415).endAngle(a.endAngle-F.padAngle()/1.415);var b=d3.select(this).selectAll(".vz-halo-link").data(G(a.data.values));b.enter().append("g").attr("class","vz-halo-link"),b.exit().remove(),b.selectAll("path").remove(),b.selectAll("circle").remove(),b.append("path").attr("class",function(a){return"vz-halo-arc-slice node-key_"+h.nodeKey(a.data)}).attr("d",E);b.each(function(a){var b=e(a),c=r[h.nodeKey(a.data)],d=d3.select(this);d.append("path").attr("class","vz-halo-link-path node-key_"+h.nodeKey(a.data)+" halo-key_"+h.haloKey(a.data)).on("mouseover",function(a,b){h.dispatch.linkover(this,a,b)}).on("mouseout",function(a,b){h.dispatch.linkout(this,a,b)}).attr("d",function(a,c){var d=I(b.arc_to_node,c);return d+="L"+String(I(b.node_to_arc,c)).substr(1),d+="A"+n+","+n+" 0 0,0 "+b.arc_to_node.source.x+","+b.arc_to_node.source.y}),c.aggregate=c.aggregate+h.value(a.data);var f=c.aggregate/c.value*c.r;d.append("circle").attr("class","vz-halo-link-node node-key_"+h.nodeKey(a.data)+" halo-key_"+h.haloKey(a.data)).attr("r",0).attr("cx",c.x-n).attr("cy",c.y-n).transition().duration(h.duration).attr("r",f)})});var d=A.selectAll(".vz-halo-node").data(t);d.enter().append("circle").attr("class",function(a){return"vz-halo-node node-key_"+a.key}).on("mouseover",function(a,b){h.dispatch.nodeover(this,a,b)}).on("mouseout",function(a,b){h.dispatch.nodeout(this,a,b)}).on("click",function(a,b){h.dispatch.nodeclick(this,a,b)}),d.exit().remove(),d.attr("r",0).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).transition().duration(h.duration).attr("r",function(a){return a.r}),h.dispatch.update()}function e(a){var b=r[h.nodeKey(a.data)],c={};c.data=a.data;var d={};d.source={},d.source.x=n*Math.cos(a.startAngle-1.57079633),d.source.y=n*Math.sin(a.startAngle-1.57079633),d.target={},d.target.x=b.x-n,d.target.y=b.y-n;var e={};return e.target={},e.target.x=n*Math.cos(a.endAngle-1.57079633),e.target.y=n*Math.sin(a.endAngle-1.57079633),e.source=d.target,c.arc_to_node=d,c.node_to_arc=e,c}function f(){p=d3.nest().key(h.haloKey).entries(h.data),q=d3.nest().key(h.nodeKey).entries(h.data);var a=d3.nest().key(h.nodeGroupKey).key(h.nodeKey).entries(h.data);g(p),g(q),r=[],q.forEach(function(a){a.nodeGroup=h.nodeGroupKey(a.values[0]),r[h.nodeKey(a.values[0])]=a}),s=[],a.forEach(function(a){var b={};b.id=a.key,b.values=q.filter(function(b){return a.key==b.nodeGroup}),b.children=b.values,s.push(b)}),g(s,"value")}function g(a,b){a.forEach(function(a){var c=0;a.values.forEach(function(a){c+=b?Number(a[b]):Number(h.value(a))}),a.value=c})}var h={},i={data:null,margin:{top:"10%",bottom:"7%",left:"9%",right:"7%"},duration:500,width:300,height:300,padAngle:1,haloThickness:.05,haloKey:null,nodeKey:null,nodeGroupKey:null,value:null},j=["linkover","nodeover","arcover","linkout","nodeout","arcout","nodeclick"],k=vizuly.component.create(a,h,i,j);k.type="viz.chart.halo_cluster";var l=!1;k.on("data_change.internal",function(){l=!0});var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=Math.PI/180,E=d3.svg.arc(),F=d3.layout.pie(),G=d3.layout.pie(),H=d3.layout.pack(),I=d3.svg.diagonal.radial();return b(),k.update=function(){return d(),k},k};